<header class="d-flex justify-content-between align-items-center p-3 bg-primary text-white">
  <h1>Create Document</h1>
</header>

<div class="container mt-4">

  <p-card header="Create Document" class="mb-4">
    <div [formGroup]="documentForm">

      <p-floatlabel variant="on">
        <input
          pInputText
          id="code"
          formControlName="code"
          class="w-full"
          autocomplete="off">
        <label for="code">Document code (ex. DOC-001)</label>
      </p-floatlabel>

    </div>

    <p-card header="Add Items" class="mb-4">
      <div [formGroup]="itemForm">

        <p-floatlabel variant="on" class="mb-3">
          <p-select
            id="article"
            formControlName="article_id"
            [options]="articles"
            optionLabel="name"
            optionValue="id"
            class="w-full">
          </p-select>
          <label for="article">Article</label>
        </p-floatlabel>

        <p-floatlabel variant="on" class="mb-3">
          <p-inputNumber
            id="quantity"
            formControlName="quantity"
            [min]="1"
            styleClass="w-full">
          </p-inputNumber>
          <label for="quantity">Quantity</label>
        </p-floatlabel>

        <p-floatlabel variant="on" class="mb-3">
          <p-select
            id="fromLocation"
            formControlName="from_location_id"
            [options]="locations"
            optionLabel="name"
            optionValue="id"
            class="w-full">
          </p-select>
          <label for="fromLocation">From location</label>
        </p-floatlabel>

        <p-floatlabel variant="on" class="mb-3">
          <p-select
            id="toLocation"
            formControlName="to_location_id"
            [options]="locations"
            optionLabel="name"
            optionValue="id"
            class="w-full">
          </p-select>
          <label for="toLocation">To location</label>
        </p-floatlabel>

        <p-button
          label="Add Item"
          icon="pi pi-plus"
          severity="success"
          [disabled]="itemForm.invalid"
          (onClick)="addItem()">
        </p-button>

        <small class="block mt-2 text-600">
          Multiple items can be added
        </small>
      </div>

      <div *ngIf="itemControls.length > 0" class="mt-4">
        <app-items-table
          [items]="itemControls"
          [articleMap]="articleMap"
          [locationMap]="locationMap"
          [removable]="true"
          (remove)="items.removeAt($event)">
        </app-items-table>
      </div>

    </p-card>
  </p-card>

  <p-button
    label="Create Document"
    icon="pi pi-check"
    severity="primary"
    [disabled]="documentForm.invalid"
    (onClick)="createDocument()">
  </p-button>

</div>

<div *ngIf="isLoggedIn()" class="mt-4">

  <p-card header="Existing Documents">

    <p-table
      [value]="documents"
      dataKey="id"
      responsiveLayout="scroll"
      styleClass="p-datatable-sm">

      <ng-template pTemplate="header">
        <tr>
          <th>Code</th>
          <th>Created</th>
          <th>Status</th>
          <th>Confirmed Date</th>
          <th>Confirmed By</th>
          <th>Action</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-d>
        <tr (click)="d.showItems = !d.showItems" style="cursor:pointer">

          <td>{{ d.code }}</td>
          <td>{{ d.created_date | date:'short' }}</td>

          <td>
            <p-tag
              [value]="d.status"
              [severity]="d.status === 'CONFIRMED' ? 'success' : 'danger'">
            </p-tag>
          </td>

          <td>
            {{ d.confirmed_date ? (d.confirmed_date | date:'short') : '-' }}
          </td>

          <td>{{ d.confirmed_by_email || '-' }}</td>

          <td>
            <p-button
              *ngIf="d.status === 'NOT CONFIRMED'"
              label="Confirm"
              icon="pi pi-check"
              severity="info"
              size="small"
              (onClick)="confirmExisting(d.id); $event.stopPropagation()">
            </p-button>
          </td>

        </tr>

        <tr *ngIf="d.showItems">
          <td colspan="6">
            <p-card class="mt-2" header="Items in {{ d.code }}">
              <app-items-table
                [items]="d.items"
                [articleMap]="articleMap"
                [locationMap]="locationMap">
              </app-items-table>
            </p-card>
          </td>
        </tr>
      </ng-template>

    </p-table>

  </p-card>
</div>