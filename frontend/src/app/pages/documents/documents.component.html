<header class="d-flex justify-content-between align-items-center p-3 bg-primary text-white">
  <h1>Create Document</h1>
</header>

<div class="container mt-4 p-3 mb-3">
  <div class="p-3 mb-3" [formGroup]="documentForm">
    <input class="form-control mb-2" formControlName="code" placeholder="Document code (ex. DOC-001)">
  </div>
  <div class="p-3 mb-3" [formGroup]="itemForm">
    <h3>Add Items</h3>
    <select class="form-select mb-2" formControlName="article_id">
      <option value="" disabled selected>Select an article</option>
      <option *ngFor="let a of articles" [value]="a.id">{{ a.name }}</option>
    </select>
    <input formControlName="quantity" type="number" placeholder="Quantity" class="form-control mb-2">

    <select class="form-select mb-2" formControlName="from_location_id">
      <option value="" disabled selected>From Location</option>
      <option *ngFor="let loc of locations" [value]="loc.id">{{ loc.name }}</option>
    </select>

    <select class="form-select mb-2" formControlName="to_location_id">
      <option value="" disabled selected>To Location</option>
      <option *ngFor="let loc of locations" [value]="loc.id">{{ loc.name }}</option>
    </select>

    <button [disabled]="itemForm.invalid" class="btn btn-success mb-3" (click)="addItem()">Add Item</button>
    <label class="p-3">Multiple items can be added!</label>
  </div>

  <app-items-table
    [items]="itemControls"
    [articleMap]="articleMap"
    [locationMap]="locationMap"
    [removable]="true"
    (remove)="items.removeAt($event)">
  </app-items-table>

  <button [disabled]="documentForm.invalid" class="btn btn-primary" (click)="createDocument()">Create Document</button>
</div>

<div *ngIf="isLoggedIn()">
  <h3>Existing Documents</h3>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Code</th>
        <th>Created</th>
        <th>Status</th>
        <th>Confirmed Date</th>
        <th>Confirmed By</th>
        <th>Action</th>
      </tr>
    </thead>

    <tbody>
      <ng-container *ngFor="let d of documents">
        <!-- Document row -->
        <tr (click)="d.showItems = !d.showItems" style="cursor:pointer;">
          <td>{{ d.code }}</td>
          <td>{{ d.created_date | date:'short' }}</td>
          <td [ngStyle]="{'background-color': d.status==='CONFIRMED' ? '#a2f6a2' : '#faabab'}">
            {{ d.status }}
          </td>
          <td>{{ d.confirmed_date ? (d.confirmed_date | date:'short') : '-' }}</td>
          <td>{{ d.confirmed_by_email || '-' }}</td>
          <td>
            <button *ngIf="d.status === 'NOT CONFIRMED'" class="btn btn-sm btn-warning"
              (click)="confirmExisting(d.id); $event.stopPropagation();">
              Confirm
            </button>
          </td>
        </tr>

        <!-- Items row -->
        <tr *ngIf="d.showItems">
          <td colspan="6">
            <h5>Items in {{ d.code }}:</h5>

            <app-items-table
              [items]="d.items"
              [articleMap]="articleMap"
              [locationMap]="locationMap">
            </app-items-table>

          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>
</div>